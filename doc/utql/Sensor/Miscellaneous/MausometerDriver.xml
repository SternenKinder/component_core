<?xml version="1.0" encoding="UTF-8"?>

<UTQLPatternTemplates xmlns='http://ar.in.tum.de/ubitrack/utql'
                      xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
                      xmlns:xi='http://www.w3.org/2001/XInclude'
                      xmlns:h='http://www.w3.org/1999/xhtml'
                      xsi:schemaLocation='http://ar.in.tum.de/ubitrack/utql ../../../schema/utql_templates.xsd'>

  <!-- Mausometer Driver -->

  <Pattern name="MausometerDriver" displayName="Driver for odometric sensors">
    <Description><p xmlns="http://www.w3.org/1999/xhtml">Gets 2D position differences of three mice</p></Description>

    <Output>
	  <Node name="Tisch" id="Tisch" displayName="Tisch">
		<GuiPos x="50" y="150"/>
	  </Node>
      <Node name="Sensor1" id="node_1" displayName="Sensor 1">
        <GuiPos x="50" y="200"/>
      </Node>
      <Node name="Sensor2" id="node_2" displayName="Sensor 2">
        <GuiPos x="100" y="200"/>
      </Node>
      <Node name="Sensor3" id="node_3" displayName="Sensor 3">
        <GuiPos x="150" y="200"/>
      </Node>

      <Edge name="Movement1" source="Tisch" destination="Sensor1" displayName="2D Measurement Sensor 1">
        <Attribute name="type" value="2DPosition" xsi:type="EnumAttributeReferenceType"/>
        <Attribute name="mode" value="push" xsi:type="EnumAttributeReferenceType"/>
      </Edge>
      <Edge name="Button1" source="Tisch" destination="Sensor1" displayName="New Data From Sensor">
        <Attribute name="type" value="Button" xsi:type="EnumAttributeReferenceType"/>
        <Attribute name="mode" value="push" xsi:type="EnumAttributeReferenceType"/>
      </Edge>


      <Edge name="Movement2" source="Tisch" destination="Sensor2" displayName="2D Measurement Sensor 2">
        <Attribute name="type" value="2DPosition" xsi:type="EnumAttributeReferenceType"/>
        <Attribute name="mode" value="push" xsi:type="EnumAttributeReferenceType"/>
      </Edge>
      <Edge name="Button2" source="Tisch" destination="Sensor2"  displayName="New Data From Sensor">
        <Attribute name="type" value="Button" xsi:type="EnumAttributeReferenceType"/>
        <Attribute name="mode" value="push" xsi:type="EnumAttributeReferenceType"/>
      </Edge>


      <Edge name="Movement3" source="Tisch" destination="Sensor3" displayName="2D Measurement Sensor 3">
        <Attribute name="type" value="2DPosition" xsi:type="EnumAttributeReferenceType"/>
        <Attribute name="mode" value="push" xsi:type="EnumAttributeReferenceType"/>
      </Edge>
      <Edge name="Button3" source="Tisch" destination="Sensor3" displayName="New Data From Sensor">
        <Attribute name="type" value="Button" xsi:type="EnumAttributeReferenceType"/>
        <Attribute name="mode" value="push" xsi:type="EnumAttributeReferenceType"/>
      </Edge>
    </Output>

    <DataflowConfiguration>
      <UbitrackLib class="MausometerDriver"/>
      <Attribute name="mausIP" displayName="Destination" default="131.159.10.60"  xsi:type="StringAttributeDeclarationType" />
      <Attribute name="mausPort" displayName="Port" default="10001" value="10001" xsi:type="IntAttributeDeclarationType"/>
    </DataflowConfiguration>
  </Pattern>


  <!-- Mausometer Tracker -->

  <Pattern name="MausometerTracker" displayName="Pose calculator for odometric sensors">
    <Description><p xmlns="http://www.w3.org/1999/xhtml">Calculates 6DoF pose increments from 2D odometric measurements</p></Description>

    <Input>
	  <Node name="Tisch" displayName="Tisch"/>
	  <Node name="Sensor1" displayName="Sensor 1"/>
	  <Node name="Sensor2" displayName="Sensor 2"/>
	  <Node name="Sensor3" displayName="Sensor 3"/>
	  <Node name="Wagen" displayName="Wagen"/>

	  <Edge name="Movement1" source="Tisch" destination="Sensor1" displayName="2D Measurement Sensor 1">
		<Predicate>type=='2DPosition'</Predicate>
	  </Edge>
	  <Edge name="Movement2" source="Tisch" destination="Sensor2" displayName="2D Measurement Sensor 2">
		<Predicate>type=='2DPosition'</Predicate>
	  </Edge>
	  <Edge name="Movement3" source="Tisch" destination="Sensor3" displayName="2D Measurement Sensor 3">
		<Predicate>type=='2DPosition'</Predicate>
	  </Edge>

	  <Edge name="MausPose1" source="Wagen" destination="Sensor1" displayName="Sensor 1 Pose">
		<Predicate>type=='3DPosition'</Predicate>
	  </Edge>
	  <Edge name="MausScale1" source="Wagen" destination="Sensor1" displayName="Sensor 1 Scale">
		<Predicate>type=='3DPosition'</Predicate>
	  </Edge>
	  <Edge name="MausPose2" source="Wagen" destination="Sensor2" displayName="Sensor 2 Pose">
		<Predicate>type=='3DPosition'</Predicate>
	  </Edge>
	  <Edge name="MausScale2" source="Wagen" destination="Sensor2" displayName="Sensor 2 Scale">
		<Predicate>type=='3DPosition'</Predicate>
	  </Edge>
	  <Edge name="MausPose3" source="Wagen" destination="Sensor3" displayName="Sensor 3 Pose">
		<Predicate>type=='3DPosition'</Predicate>
	  </Edge>
	  <Edge name="MausScale3" source="Wagen" destination="Sensor3" displayName="Sensor 3 Scale">
		<Predicate>type=='3DPosition'</Predicate>
	  </Edge>
    </Input>

    <Output>
           <Edge name="WagenPoseDelta" source="Tisch" destination="Wagen" displayName="Wagen Delta">
               <Attribute name="type" value="6D" xsi:type="EnumAttributeReferenceType"/>
               <Attribute name="mode" value="push" xsi:type="EnumAttributeReferenceType"/>
           </Edge>
    </Output>

    <Constraints>
     	<TriggerGroup>
            <Edge edge-ref="Movement1"/>
            <Edge edge-ref="Movement2"/>
            <Edge edge-ref="Movement3"/>
            <Edge edge-ref="MausPose1"/>
            <Edge edge-ref="MausPose2"/>
            <Edge edge-ref="MausPose3"/>
            <Edge edge-ref="MausScale1"/>
            <Edge edge-ref="MausScale2"/>
            <Edge edge-ref="MausScale3"/>
            <Edge edge-ref="WagenPoseDelta"/>
        </TriggerGroup>
    </Constraints>

    <DataflowConfiguration>
	  <UbitrackLib class="MausometerTracker"/>
    </DataflowConfiguration>
  </Pattern>


  <!-- Mausometer Integrator -->

  <Pattern name="MausometerAggregator" displayName="Pose aggregator for odometric sensors">
    <Description><p xmlns="http://www.w3.org/1999/xhtml">Aggregates 6DoF deltas from mausometer tracker into final pose</p></Description>

    <Input>
	  <Node name="Tisch" displayName="Tisch"/>
	  <Node name="Wagen" displayName="Wagen"/>

	  <Edge name="Increment" source="Tisch" destination="Wagen" displayName="Pose Increment">
		<Predicate>type=='6D'&amp;&amp;mode=='push'</Predicate>
	  </Edge>
	  <Edge name="Absolute" source="Tisch" destination="Wagen" displayName="Absolute Pose">
		<Predicate>type=='6D'&amp;&amp;mode=='push'</Predicate>
	  </Edge>
    </Input>

	<Output>
	  <Edge name="Output" source="Tisch" destination="Wagen" displayName="Wagen Pose">
        <Attribute name="type" value="6D" xsi:type="EnumAttributeReferenceType"/>
        <Attribute name="mode" value="push" xsi:type="EnumAttributeReferenceType"/>
	  </Edge>
	</Output>

    <DataflowConfiguration>
	  <UbitrackLib class="MausometerPoseAggregator"/>
    </DataflowConfiguration>
  </Pattern>


  <!-- Attribute declarations -->

  <GlobalNodeAttributeDeclarations>
    <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/1/1)"/>
  </GlobalNodeAttributeDeclarations>

  <GlobalEdgeAttributeDeclarations>
    <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/2/1)"/>
    <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/2/2)"/>
    <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/2/3)"/>
    <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/2/4)"/>
    <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/2/5)"/>
    <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/2/6)"/>
    <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/2/7)"/>
    <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/2/8)"/>
  </GlobalEdgeAttributeDeclarations>

  <GlobalDataflowAttributeDeclarations>
    <!-- Unfortunately, the xpointer used in Xinclude is currently restricted to the element scheme and absolute element indices in Xerces (and thus XMLBeans) -->
    <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/3/1)"/>
    <xi:include href="file:GlobalAttrSpec.xml" xpointer="element(/1/3/2)"/>
  </GlobalDataflowAttributeDeclarations>

</UTQLPatternTemplates>
